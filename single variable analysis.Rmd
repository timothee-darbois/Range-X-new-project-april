---
title: "single variable analysis"
author: "Timothée Darbois"
date: "2024-04-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ade4)
library(ggplot2)
library(tidyverse)
library(googlesheets4)
library(dplyr)
library(rstatix)
library(readxl)
library(Factoshiny)
library(vegan)
library(missMDA)
library(ggvegan)
library(ggordiplots)
library(GGally)
library(patchwork)
library(jtools)
library(lme4)
library(interactions)
library(multcomp)
library(effects)

library(performance)
library(lmerTest)



```
```{r}
df_Tim<-read.csv('D:/mes_documents/M1/stage/data/csv/rangeX seeds even number (2).xlsx - Feuille 1.csv',dec=",", na.strings = c("#DIV/0!"))

df_Tim<-as.data.frame(df_Tim)
df_Tim<- df_Tim %>% mutate(student='Timothée')

```


```{r}
df_Ingrid<-read.csv('D:/mes_documents/M1/stage/data/csv/Copie de Seeds rangeX Timothée - Seeds odd numbers.csv', dec=",", na.strings = c("#DIV/0!"))
df_Ingrid<-as.data.frame(df_Ingrid)
df_Ingrid<- df_Ingrid %>% mutate(student='Ingrid')


```

```{r}
df1<-df_Tim%>% dplyr::select(1,2,3,4,5,6,7,8,9,10,11,12,13,"student")
df2<-df_Ingrid%>% dplyr::select(1,2,3,4,5,6,7,8,9,10,11,12,13,"student")
df<-rbind(df1,df2)

df<-df %>% mutate(seeds_number.inf=as.integer(seeds_number.inf))

df<-df%>%
  filter(!is.na(weight.inf))

df<-df %>% mutate(condi=paste(df$site,df$plotID,sep=","))

df<-df %>% mutate(merge_ID=paste(df$site,df$blockID,df$plotID,df$positionID_clean, sep=" "))

```

removing na from the column seed weight, and preparing columnb for log ( adding small constant to avoid 0)
```{r}
df$weight.seed[is.na(df$weight.seed)]<-0
c<-which(df$weight.inf!= 0)
c1<-min(df$weight.inf[c])/100

c<-which(df$weight.seed!= 0)
c2<-min(df$weight.seed[c])/100

df<-data.frame(df,weight.inf.log=df$weight.inf+c1,weight.seed.log=df$weight.seed+c2)
```

```{r}
df<-data.frame(df,temperature=paste(df$treat1,df$site))
df$temperature<-str_replace(df$temperature,"LS","ambient LS")
```

```{r}
demo_trait_high<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_demographic_traits_high_2023.xlsx",sheet=2)
demo_trait_low<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_demographic_traits_low_2023.xlsx",sheet=2)
func_trait<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_functional_traits_2023.xlsx",sheet=2)

```

```{r}
demo_trait_high<-demo_trait_high %>% mutate(site= rep("HS",nrow(demo_trait_high)))
demo_trait_low<-demo_trait_low %>% mutate( site= rep("LS",nrow(demo_trait_low)))
demo_trait<-rbind(demo_trait_high,demo_trait_low)

demo_trait<-demo_trait %>% mutate(merge_ID=paste(demo_trait$site,demo_trait$block,str_to_upper (demo_trait$treat),demo_trait$coord, sep=" "))


func_trait<-func_trait %>% mutate(merge_ID=paste(func_trait$site,func_trait$blockID,func_trait$plotID,func_trait$positionID, sep=" "))

# thickness was measured three times, for more precision
func_trait<-func_trait %>% mutate(thickness=rowMeans(data.frame(func_trait$thickness_1,func_trait$thickness_2,func_trait$thickness_3),na.rm=TRUE))


#converting into numeric the flowers data
demo_trait<-demo_trait %>% mutate(no_flowers_col1= as.numeric(  no_flowers_col1)  ,no_flowers_col10= as.numeric (
 no_flowers_col10) , no_flowers_col2= as.numeric ( no_flowers_col2), 
no_flowers_col3= as.numeric ( no_flowers_col3), no_flowers_col4= as.numeric ( no_flowers_col4), no_flowers_col5= as.numeric (no_flowers_col5),
 no_flowers_col6= as.numeric (no_flowers_col6), no_flowers_col7= as.numeric ( no_flowers_col7),no_flowers_col8= as.numeric (no_flowers_col8), no_flowers_col9= as.numeric ( no_flowers_col9),no_flowers_col9= as.numeric(no_flowers_col9), no_flowers_col11= as.numeric(no_flowers_col11), no_flowers_col12= as.numeric(no_flowers_col12), no_flowers_col13= as.numeric (no_flowers_col13) ,no_flowers_col14= as.numeric ( no_flowers_col14), no_flowers_col15= as.numeric (no_flowers_col15) ,no_flowers_col16= as.numeric (no_flowers_col16) ,no_flowers_col17= as.numeric (no_flowers_col17), no_flowers_col18= as.numeric (no_flowers_col18) ,no_flowers_col19= as.numeric (no_flowers_col19) ,no_flowers_col20= as.numeric (no_flowers_col20), no_flowers_col21= as.numeric (no_flowers_col21) ,no_flowers_col22= as.numeric (no_flowers_col22) ,no_flowers_col23= as.numeric (no_flowers_col23),no_flowers_col24= as.numeric ( no_flowers_col24), no_flowers_col25= as.numeric (no_flowers_col25) ,no_flowers_col26= as.numeric (no_flowers_col26),no_flowers_col27= as.numeric ( no_flowers_col27) ,no_flowers_col28= as.numeric (no_flowers_col28),no_flowers_col29= as.numeric (no_flowers_col29), no_flowers_col30= as.numeric (no_flowers_col30) ,no_flowers_col31= as.numeric (no_flowers_col31) ,no_flowers_col32= as.numeric ( no_flowers_col32), no_flowers_col33= as.numeric ( no_flowers_col33) ,no_flowers_col34= as.numeric (no_flowers_col34) ,no_flowers_col35= as.numeric ( no_flowers_col35), no_flowers_col36= as.numeric ( no_flowers_col36) ,no_flowers_col37= as.numeric (no_flowers_col37) ,no_flowers_col38= as.numeric ( no_flowers_col38), no_flowers_col39= as.numeric ( no_flowers_col39) ,no_flowers_col40= as.numeric (no_flowers_col40) ,no_flowers_col41= as.numeric ( no_flowers_col41), no_flowers_col42= as.numeric (no_flowers_col42) ,no_flowers_col43= as.numeric (no_flowers_col43) ,no_flowers_col44= as.numeric ( no_flowers_col44), no_flowers_col45= as.numeric ( no_flowers_col45) ,no_flowers_col46= as.numeric (no_flowers_col46) ,no_flowers_col47= as.numeric ( no_flowers_col47))

#computing the total number of flowers per individual
demo_trait<-demo_trait %>% 
  rowwise %>% 
  mutate(no_flowers_tt=sum(c_across(c("no_flowers_col1","no_flowers_col10","no_flowers_col2","no_flowers_col3","no_flowers_col4","no_flowers_col5","no_flowers_col6","no_flowers_col7","no_flowers_col8","no_flowers_col9","no_flowers_col9","no_flowers_col11","no_flowers_col12","no_flowers_col13","no_flowers_col14","no_flowers_col15","no_flowers_col16","no_flowers_col17","no_flowers_col18","no_flowers_col19","no_flowers_col20","no_flowers_col21","no_flowers_col22","no_flowers_col23","no_flowers_col24","no_flowers_col25","no_flowers_col26","no_flowers_col27","no_flowers_col28","no_flowers_col29","no_flowers_col30","no_flowers_col31","no_flowers_col32","no_flowers_col33","no_flowers_col34","no_flowers_col35","no_flowers_col36","no_flowers_col37","no_flowers_col38","no_flowers_col39","no_flowers_col40","no_flowers_col41","no_flowers_col42","no_flowers_col43","no_flowers_col44","no_flowers_col45","no_flowers_col46","no_flowers_col47")),na.rm=TRUE))

func_trait$bulknr[is.na(func_trait$bulknr)]<-1
func_trait<-transform(func_trait, dry_mass = `dry_mass`/`bulknr`) 
func_trait<-transform(func_trait, wet_mass = `wet_mass`/`bulknr`) # number of leaves taken into account ) bulknr ( sometimes 2), so transformation to have the mass/ leaf

#sampled quarter = sometimes only 1/4 of the individual is measured. to have an approximation of measurments / indiv, we have to multiply everything by 4 when sampled_quarted="yes"
demo_trait$sampled_quarter<-as.numeric(sub("yes",4,demo_trait$sampled_quarter))
demo_trait$sampled_quarter[is.na(demo_trait$sampled_quarter)]<-1
demo_trait<-transform(demo_trait, no_leaves = `no_leaves`*`sampled_quarter`)

all_trait<-merge(func_trait,demo_trait,by="merge_ID")
all_trait<-merge(all_trait,df,by="merge_ID")

```

```{r}
all_trait_pca<-all_trait[all_trait$species %in% c("CN","SP","TP","PS","PL","LM","LV"), ]

for (i in 1:47){
  column=paste("no_flowers_col",i,sep="")
  all_trait_pca[,column]<-NULL
}
all_trait_pca$date.x<-NULL
all_trait_pca$ID.x<-NULL
all_trait_pca$site.x<-NULL
all_trait_pca$species.x<-NULL
all_trait_pca$treat1.x<-NULL
all_trait_pca$treat2.x<-NULL
all_trait_pca$blockID.x<-NULL
all_trait_pca$plotID.x<-NULL
all_trait_pca$positionID.x<-NULL
all_trait_pca$thickness_1<-NULL
all_trait_pca$thickness_2<-NULL
all_trait_pca$thickness_3<-NULL
```


```{r}
demo_trait<-demo_trait %>%mutate(condi =paste(demo_trait$site,demo_trait$treat,sep=" "))
#competition
demo_trait<-demo_trait %>% mutate(competition = demo_trait$condi)
demo_trait$competition<-str_replace(demo_trait$competition,"HS e","bare")
demo_trait$competition<-str_replace(demo_trait$competition,"HS a","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"HS b","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"HS f","bare")
demo_trait$competition<-str_replace(demo_trait$competition,"LS a","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"LS b","bare")

#temperature
demo_trait<-demo_trait %>% mutate(temperature = demo_trait$condi)
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS e","High warm")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS a","High warm")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS b","High ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS f","High ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"LS a","Low ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"LS b","Low ambient")



```





# glmm on vegetativ height
```{r}

#releveling temperature: reference = ambient HS
all_trait_pca$temp<-relevel(as.factor(all_trait_pca$temperature),"ambient HS")

glmm_vegh1<- lmer(height_veg_cm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_vegh2<- lmer(height_veg_cm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_vegh3<- lmer(height_veg_cm~temp +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_vegh4<- lmer(height_veg_cm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_vegh1,show.intercept = T)
sjPlot::plot_model(glmm_vegh1, show.values = TRUE, width = 0.1, title = "effect of treatment on vegetativ height")


sjPlot::tab_model(glmm_vegh2,show.intercept = T)
sjPlot::plot_model(glmm_vegh2, show.values = TRUE, width = 0.1, title = "effect of transplantation on seeds number per infructescence") 

sjPlot::tab_model(glmm_vegh3,show.intercept = T)
sjPlot::plot_model(glmm_vegh3, show.values = TRUE, width = 0.1, title = "effect of warming on seeds number per infructescence") 

sjPlot::tab_model(glmm_vegh4,show.intercept = T)
sjPlot::plot_model(glmm_vegh4, show.values = TRUE, width = 0.1, title = "effect of competition on seeds number per infructescence") 
```

### post hoc analysis
```{r}
summary(glht(glmm_vegh1, mcp(condi="Tukey")))

```



### check performance : that ' s ok for everything I think
```{r}
check_glmm_test<-check_model(glmm_vegh1)
plot(check_glmm_test)
```

```{r}
a<-fixef(glmm_vegh1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_vegh1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence seed number per infructescence")
plot_final

```



# glmm on reproductive height
```{r}

#releveling temperature: reference = ambient HS
all_trait_pca$temp<-relevel(as.factor(all_trait_pca$temperature),"ambient HS")

glmm_reph1<- lmer(height_rep_cm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_reph2<- lmer(height_rep_cm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_reph3<- lmer(height_rep_cm~temp +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_reph4<- lmer(height_rep_cm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_reph1,show.intercept = T)
sjPlot::plot_model(glmm_reph1, show.values = TRUE, width = 0.1, title = "effect of treatment on reproductive height")


sjPlot::tab_model(glmm_reph2,show.intercept = T)
sjPlot::plot_model(glmm_reph2, show.values = TRUE, width = 0.1, title = "effect of transplantation on reproductive height per infructescence") 

sjPlot::tab_model(glmm_reph3,show.intercept = T)
sjPlot::plot_model(glmm_reph3, show.values = TRUE, width = 0.1, title = "effect of warming on reproductive height per infructescence") 

sjPlot::tab_model(glmm_reph4,show.intercept = T)
sjPlot::plot_model(glmm_reph4, show.values = TRUE, width = 0.1, title = "effect of competition on reproductive height per infructescence") 
```

### post hoc analysis
```{r}
summary(glht(glmm_reph1, mcp(condi="Tukey")))

```



### check performance : that ' s ok for everything I think
```{r}
check_glmm_test<-check_model(glmm_reph1)
plot(check_glmm_test)
```

```{r}
a<-fixef(glmm_reph1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_vegh1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence seed number per infructescence")
plot_final

```


# glmm on leaves number
```{r}

#releveling temperature: reference = ambient HS
all_trait_pca$temp<-relevel(as.factor(all_trait_pca$temperature),"ambient HS")

glmm_nol1<- glmer.nb(no_leaves~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_nol2<- glmer.nb(no_leaves~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nol3<- glmer.nb(no_leaves~temp +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_nol4<- glmer.nb(no_leaves~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nol1,show.intercept = T)
sjPlot::plot_model(glmm_nol1, show.values = TRUE, width = 0.1, title = "effect of treatment on leaves number")


sjPlot::tab_model(glmm_nol2,show.intercept = T)
sjPlot::plot_model(glmm_nol2, show.values = TRUE, width = 0.1, title = "effect of transplantation on leaves number per infructescence") 

sjPlot::tab_model(glmm_nol3,show.intercept = T)
sjPlot::plot_model(glmm_nol3, show.values = TRUE, width = 0.1, title = "effect of warming on leaves number per infructescence") 

sjPlot::tab_model(glmm_nol4,show.intercept = T)
sjPlot::plot_model(glmm_nol4, show.values = TRUE, width = 0.1, title = "effect of competition on leaves number per infructescence") 
```

### post hoc analysis
```{r}
summary(glht(glmm_nol1, mcp(condi="Tukey")))

```



```{r}
check_glmm_test<-check_model(glmm_nol1)
plot(check_glmm_test)
```
```{r}
check_overdispersion(glmm_nol1)

```
results with a poisson family:

 dispersion ratio =    37.501
  Pearson's Chi-Squared = 13012.737
                p-value =   < 0.001
=> overdispersed : use a neg bin.

```{r}
a<-fixef(glmm_nol1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_nol1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence seed number per infructescence")
plot_final

```


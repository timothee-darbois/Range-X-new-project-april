---
title: "single variable analysis"
author: "Timothée Darbois"
date: "2024-04-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ade4)
library(ggplot2)
library(tidyverse)
library(googlesheets4)
library(dplyr)
library(rstatix)
library(readxl)
library(Factoshiny)
library(vegan)
library(missMDA)
library(ggvegan)
library(ggordiplots)
library(GGally)
library(patchwork)
library(jtools)
library(lme4)
library(interactions)
library(multcomp)
library(effects)
library(sjPlot)

library(performance)
library(lmerTest)

library(ggpubr)

library(cowplot)


```
```{r}
df_Tim<-read.csv('D:/mes_documents/M1/stage/data/csv/rangeX seeds even number (2).xlsx - Feuille 1.csv',dec=",", na.strings = c("#DIV/0!"))

df_Tim<-as.data.frame(df_Tim)
df_Tim<- df_Tim %>% mutate(student='Timothée')

```


```{r}
df_Ingrid<-read.csv('D:/mes_documents/M1/stage/data/csv/Copie de Seeds rangeX Timothée - Seeds odd numbers.csv', dec=",", na.strings = c("#DIV/0!"))
df_Ingrid<-as.data.frame(df_Ingrid)
df_Ingrid<- df_Ingrid %>% mutate(student='Ingrid')


```

```{r}
df1<-df_Tim%>% dplyr::select(1,2,3,4,5,6,7,8,9,10,11,12,13,"student")
df2<-df_Ingrid%>% dplyr::select(1,2,3,4,5,6,7,8,9,10,11,12,13,"student")
df<-rbind(df1,df2)

df<-df %>% mutate(seeds_number.inf=as.integer(seeds_number.inf))

df<-df%>%
  filter(!is.na(weight.inf))

df<-df %>% mutate(condi=paste(df$site,df$plotID,sep=","))

df<-df %>% mutate(merge_ID=paste(df$site,df$blockID,df$plotID,df$positionID_clean, sep=" "))

```

removing na from the column seed weight, and preparing columnb for log ( adding small constant to avoid 0)
```{r}
df$weight.seed[is.na(df$weight.seed)]<-0
c<-which(df$weight.inf!= 0)
c1<-min(df$weight.inf[c])/100

c<-which(df$weight.seed!= 0)
c2<-min(df$weight.seed[c])/100

df<-data.frame(df,weight.inf.log=df$weight.inf+c1,weight.seed.log=df$weight.seed+c2)
```

```{r}
df<-data.frame(df,temperature=paste(df$treat1,df$site))
df$temperature<-str_replace(df$temperature,"LS","ambient LS")
```

```{r}
demo_trait_high<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_demographic_traits_high_2023.xlsx",sheet=2)
demo_trait_low<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_demographic_traits_low_2023.xlsx",sheet=2)
func_trait<-read_excel(path="C:/Users/timot/Documents/M1/stage/data_analysis/data/RangeX_raw_functional_traits_2023.xlsx",sheet=2)

```

```{r}
demo_trait_high<-demo_trait_high %>% mutate(site= rep("HS",nrow(demo_trait_high)))
demo_trait_low<-demo_trait_low %>% mutate( site= rep("LS",nrow(demo_trait_low)))
demo_trait<-rbind(demo_trait_high,demo_trait_low)

demo_trait<-demo_trait %>% mutate(merge_ID=paste(demo_trait$site,demo_trait$block,str_to_upper (demo_trait$treat),demo_trait$coord, sep=" "))


func_trait<-func_trait %>% mutate(merge_ID=paste(func_trait$site,func_trait$blockID,func_trait$plotID,func_trait$positionID, sep=" "))

# thickness was measured three times, for more precision
func_trait<-func_trait %>% mutate(thickness=rowMeans(data.frame(func_trait$thickness_1,func_trait$thickness_2,func_trait$thickness_3),na.rm=TRUE))


#converting into numeric the flowers data
demo_trait<-demo_trait %>% mutate(no_flowers_col1= as.numeric(  no_flowers_col1)  ,no_flowers_col10= as.numeric (
 no_flowers_col10) , no_flowers_col2= as.numeric ( no_flowers_col2), 
no_flowers_col3= as.numeric ( no_flowers_col3), no_flowers_col4= as.numeric ( no_flowers_col4), no_flowers_col5= as.numeric (no_flowers_col5),
 no_flowers_col6= as.numeric (no_flowers_col6), no_flowers_col7= as.numeric ( no_flowers_col7),no_flowers_col8= as.numeric (no_flowers_col8), no_flowers_col9= as.numeric ( no_flowers_col9),no_flowers_col9= as.numeric(no_flowers_col9), no_flowers_col11= as.numeric(no_flowers_col11), no_flowers_col12= as.numeric(no_flowers_col12), no_flowers_col13= as.numeric (no_flowers_col13) ,no_flowers_col14= as.numeric ( no_flowers_col14), no_flowers_col15= as.numeric (no_flowers_col15) ,no_flowers_col16= as.numeric (no_flowers_col16) ,no_flowers_col17= as.numeric (no_flowers_col17), no_flowers_col18= as.numeric (no_flowers_col18) ,no_flowers_col19= as.numeric (no_flowers_col19) ,no_flowers_col20= as.numeric (no_flowers_col20), no_flowers_col21= as.numeric (no_flowers_col21) ,no_flowers_col22= as.numeric (no_flowers_col22) ,no_flowers_col23= as.numeric (no_flowers_col23),no_flowers_col24= as.numeric ( no_flowers_col24), no_flowers_col25= as.numeric (no_flowers_col25) ,no_flowers_col26= as.numeric (no_flowers_col26),no_flowers_col27= as.numeric ( no_flowers_col27) ,no_flowers_col28= as.numeric (no_flowers_col28),no_flowers_col29= as.numeric (no_flowers_col29), no_flowers_col30= as.numeric (no_flowers_col30) ,no_flowers_col31= as.numeric (no_flowers_col31) ,no_flowers_col32= as.numeric ( no_flowers_col32), no_flowers_col33= as.numeric ( no_flowers_col33) ,no_flowers_col34= as.numeric (no_flowers_col34) ,no_flowers_col35= as.numeric ( no_flowers_col35), no_flowers_col36= as.numeric ( no_flowers_col36) ,no_flowers_col37= as.numeric (no_flowers_col37) ,no_flowers_col38= as.numeric ( no_flowers_col38), no_flowers_col39= as.numeric ( no_flowers_col39) ,no_flowers_col40= as.numeric (no_flowers_col40) ,no_flowers_col41= as.numeric ( no_flowers_col41), no_flowers_col42= as.numeric (no_flowers_col42) ,no_flowers_col43= as.numeric (no_flowers_col43) ,no_flowers_col44= as.numeric ( no_flowers_col44), no_flowers_col45= as.numeric ( no_flowers_col45) ,no_flowers_col46= as.numeric (no_flowers_col46) ,no_flowers_col47= as.numeric ( no_flowers_col47))

#computing the total number of flowers per individual
demo_trait<-demo_trait %>% 
  rowwise %>% 
  mutate(no_flowers_tt=sum(c_across(c("no_flowers_col1","no_flowers_col10","no_flowers_col2","no_flowers_col3","no_flowers_col4","no_flowers_col5","no_flowers_col6","no_flowers_col7","no_flowers_col8","no_flowers_col9","no_flowers_col9","no_flowers_col11","no_flowers_col12","no_flowers_col13","no_flowers_col14","no_flowers_col15","no_flowers_col16","no_flowers_col17","no_flowers_col18","no_flowers_col19","no_flowers_col20","no_flowers_col21","no_flowers_col22","no_flowers_col23","no_flowers_col24","no_flowers_col25","no_flowers_col26","no_flowers_col27","no_flowers_col28","no_flowers_col29","no_flowers_col30","no_flowers_col31","no_flowers_col32","no_flowers_col33","no_flowers_col34","no_flowers_col35","no_flowers_col36","no_flowers_col37","no_flowers_col38","no_flowers_col39","no_flowers_col40","no_flowers_col41","no_flowers_col42","no_flowers_col43","no_flowers_col44","no_flowers_col45","no_flowers_col46","no_flowers_col47")),na.rm=TRUE))

func_trait$bulknr[is.na(func_trait$bulknr)]<-1
func_trait<-transform(func_trait, dry_mass = `dry_mass`/`bulknr`) 
func_trait<-transform(func_trait, wet_mass = `wet_mass`/`bulknr`) # number of leaves taken into account ) bulknr ( sometimes 2), so transformation to have the mass/ leaf

# LDMC
func_trait<-func_trait %>% mutate(LDMC=func_trait$dry_mass/func_trait$wet_mass)

#sampled quarter = sometimes only 1/4 of the individual is measured. to have an approximation of measurments / indiv, we have to multiply everything by 4 when sampled_quarted="yes"
demo_trait$sampled_quarter<-as.numeric(sub("yes",4,demo_trait$sampled_quarter))
demo_trait$sampled_quarter[is.na(demo_trait$sampled_quarter)]<-1
demo_trait<-transform(demo_trait, no_leaves = `no_leaves`*`sampled_quarter`)

all_trait<-merge(func_trait,demo_trait,by="merge_ID")
all_trait<-merge(all_trait,df,by="merge_ID")

```

```{r}
all_trait_pca<-all_trait[all_trait$species %in% c("CN","SP","TP","PS","PL","LM","LV"), ]

for (i in 1:47){
  column=paste("no_flowers_col",i,sep="")
  all_trait_pca[,column]<-NULL
}
all_trait_pca$date.x<-NULL
all_trait_pca$ID.x<-NULL
all_trait_pca$site.x<-NULL
all_trait_pca$species.x<-NULL
all_trait_pca$treat1.x<-NULL
all_trait_pca$treat2.x<-NULL
all_trait_pca$blockID.x<-NULL
all_trait_pca$plotID.x<-NULL
all_trait_pca$positionID.x<-NULL
all_trait_pca$thickness_1<-NULL
all_trait_pca$thickness_2<-NULL
all_trait_pca$thickness_3<-NULL
```


```{r}
demo_trait<-demo_trait %>%mutate(condi =paste(demo_trait$site,demo_trait$treat,sep=" "))
#competition
demo_trait<-demo_trait %>% mutate(competition = demo_trait$condi)
demo_trait$competition<-str_replace(demo_trait$competition,"HS e","bare")
demo_trait$competition<-str_replace(demo_trait$competition,"HS a","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"HS b","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"HS f","bare")
demo_trait$competition<-str_replace(demo_trait$competition,"LS a","vegetation")
demo_trait$competition<-str_replace(demo_trait$competition,"LS b","bare")

#temperature
demo_trait<-demo_trait %>% mutate(temperature = demo_trait$condi)
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS e","High warm")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS a","High warm")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS b","High ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"HS f","High ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"LS a","Low ambient")
demo_trait$temperature<-str_replace(demo_trait$temperature,"LS b","Low ambient")



```





# glmm on vegetativ height

## bricolage
```{r}
#t<-all_trait_pca[which(all_trait_pca$species=="TP"),]
#plot_vegh<- ggplot(all_trait_pca, aes(x=condi, y=log( ))+geom_boxplot(aes(fill=student)) + geom_dotplot(binaxis = 'y',dotsize = 0.01,stackdir = 'center') +theme_classic() 
```

```{r}

#releveling temperature: reference = ambient HS
all_trait_pca$temperature<-relevel(as.factor(all_trait_pca$temperature),"ambient HS")

glmm_vegh1<- lmer(height_veg_cm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_vegh2<- lmer(height_veg_cm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_vegh3<- lmer(height_veg_cm~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_vegh4<- lmer(height_veg_cm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_vegh1,show.intercept = T)
sjPlot::plot_model(glmm_vegh1, show.values = TRUE, width = 0.1, title = "effect of treatment on vegetativ height")


sjPlot::tab_model(glmm_vegh2,show.intercept = T)
sjPlot::plot_model(glmm_vegh2, show.values = TRUE, width = 0.1, title = "effect of transplantation on seeds number per infructescence") 

sjPlot::tab_model(glmm_vegh3,show.intercept = T)
sjPlot::plot_model(glmm_vegh3, show.values = TRUE, width = 0.1, title = "effect of warming on seeds number per infructescence") 

sjPlot::tab_model(glmm_vegh4,show.intercept = T)
sjPlot::plot_model(glmm_vegh4, show.values = TRUE, width = 0.1, title = "effect of competition on seeds number per infructescence") 
```
## interactions
```{r}
glmm_vegh_sc<- lmer(height_veg_cm~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_vegh_tc<- lmer(height_veg_cm~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_vegh_sc,show.intercept = T)
sjPlot::plot_model(glmm_vegh_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on vegetative height") 
sjPlot::tab_model(glmm_vegh_tc,show.intercept = T)
sjPlot::plot_model(glmm_vegh_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on vegetative height") 
```


### post hoc analysis
```{r}
summary(glht(glmm_vegh1, mcp(condi="Tukey")))

```



### check performance : that ' s ok for everything I think
```{r}
check_glmm_test<-check_model(glmm_vegh1)
plot(check_glmm_test)
```

```{r}
a<-fixef(glmm_vegh1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_vegh1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence seed number per infructescence")
plot_final

```

##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$height_veg_cm <- predict(glmm_vegh_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_vegh_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_vegh_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_vegh_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$height_veg_cm-cmult*sqrt(pvar1)
    , phi = newdat$height_veg_cm+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_vegh <- ggplot(newdat, aes(x=treat2.y, y=height_veg_cm, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("vegetative height (cm)")

g0_vegh<-ggdraw(add_sub(g0_vegh, "Competition:*** Site:NS Temperature:**"))

g0_vegh
```


# glmm on reproductive height
```{r}


glmm_reph1<- lmer(height_rep_cm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_reph2<- lmer(height_rep_cm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_reph3<- lmer(height_rep_cm~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_reph4<- lmer(height_rep_cm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_reph1,show.intercept = T)
sjPlot::plot_model(glmm_reph1, show.values = TRUE, width = 0.1, title = "effect of treatment on reproductive height")


sjPlot::tab_model(glmm_reph2,show.intercept = T)
sjPlot::plot_model(glmm_reph2, show.values = TRUE, width = 0.1, title = "effect of transplantation on reproductive height per infructescence") 

sjPlot::tab_model(glmm_reph3,show.intercept = T)
sjPlot::plot_model(glmm_reph3, show.values = TRUE, width = 0.1, title = "effect of warming on reproductive height") 

sjPlot::tab_model(glmm_reph4,show.intercept = T)
sjPlot::plot_model(glmm_reph4, show.values = TRUE, width = 0.1, title = "effect of competition on reproductive height") 
```

## interactions

```{r}
glmm_reph_sc<-lmer(height_rep_cm~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_reph_tc<-lmer(height_rep_cm~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_reph_sc,show.intercept = T)
plot_model(glmm_reph_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on reproductive height per infructescence") 
sjPlot::tab_model(glmm_vegh_tc,show.intercept = T)
plot_model(glmm_reph_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on reproductive height per infructescence") 
```
### post hoc analysis
```{r}
summary(glht(glmm_reph1, mcp(condi="Tukey")))

```



### check performance : that ' s ok for everything I think
```{r}
check_glmm_test<-check_model(glmm_reph1)
plot(check_glmm_test)
```

```{r}
a<-fixef(glmm_reph1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_reph1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence seed number per infructescence")
plot_final

```
##final graph with confidence interval
```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$height_rep_cm <- predict(glmm_reph_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_reph_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_reph_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_reph_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$height_rep_cm-cmult*sqrt(pvar1)
    , phi = newdat$height_rep_cm+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_reph <- ggplot(newdat, aes(x=treat2.y, y=height_rep_cm, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("reproductive height (cm)")

g0_reph<-ggdraw(add_sub(g0_reph, "Competition: Site: Temperature: "))

g0_reph
```


# glmm on leaves number
```{r}
glmm_nol1<- glmer.nb(no_leaves~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
#gllm_test<-glmer.nb(height_veg_cm~condi + (1|blockID)+ (1|species), data=all_trait_pca)

glmm_nol2<- glmer.nb(no_leaves~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nol3<- glmer.nb(no_leaves~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_nol4<- glmer.nb(no_leaves~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nol1,show.intercept = T)
sjPlot::plot_model(glmm_nol1, show.values = TRUE, width = 0.1, title = "effect of treatment on leaves number")


sjPlot::tab_model(glmm_nol2,show.intercept = T)
sjPlot::plot_model(glmm_nol2, show.values = TRUE, width = 0.1, title = "effect of transplantation on leaves number per infructescence") 

sjPlot::tab_model(glmm_nol3,show.intercept = T)
sjPlot::plot_model(glmm_nol3, show.values = TRUE, width = 0.1, title = "effect of warming on leaves number per infructescence") 

sjPlot::tab_model(glmm_nol4,show.intercept = T)
sjPlot::plot_model(glmm_nol4, show.values = TRUE, width = 0.1, title = "effect of competition on leaves number per infructescence") 
```
## interactions
```{r}
glmm_nol_sc<- lmer(no_leaves~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nol_tc<- lmer(no_leaves~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nol_sc,show.intercept = T)
plot_model(glmm_nol_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on number of leaves") 
sjPlot::tab_model(glmm_nol_tc,show.intercept = T)
plot_model(glmm_nol_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on number of leaves") 
```
## post hoc analysis
```{r}
summary(glht(glmm_nol1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_nol1)
plot(check_glmm_test)
```
```{r}
check_overdispersion(glmm_nol1)

```
results with a poisson family:

 dispersion ratio =    37.501
  Pearson's Chi-Squared = 13012.737
                p-value =   < 0.001
=> overdispersed : use a neg bin.
## final graph
```{r}
a<-fixef(glmm_nol1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_nol1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the number of leaves")
plot_final

```

##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$no_leaves <- predict(glmm_nol_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_nol_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_nol_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_nol_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$no_leaves-cmult*sqrt(pvar1)
    , phi = newdat$no_leaves+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)

newdat<-newdat %>% transform(no_leaves=exp(no_leaves),plo=exp(plo),phi=exp(phi))

#plot confidence
g0_nol <- ggplot(newdat, aes(x=treat2.y, y=no_leaves, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("number of leaves/ individual")

g0_nol<-ggdraw(add_sub(g0_nol, "Competition: Site: Temperature: "))

g0_nol
```


# glmm on flower number
```{r}
glmm_nof1<- glmer.nb(no_flowers_tt~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nof2<- glmer.nb(no_flowers_tt~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nof3<- glmer.nb(no_flowers_tt~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_nof4<- glmer.nb(no_flowers_tt~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nof1,show.intercept = T)
sjPlot::plot_model(glmm_nof1, show.values = TRUE, width = 0.1, title = "effect of treatment on flower number")


sjPlot::tab_model(glmm_nof2,show.intercept = T)
sjPlot::plot_model(glmm_nof2, show.values = TRUE, width = 0.1, title = "effect of transplantation on flower number per infructescence") 

sjPlot::tab_model(glmm_nof3,show.intercept = T)
sjPlot::plot_model(glmm_nof3, show.values = TRUE, width = 0.1, title = "effect of warming on flower number per infructescence") 

sjPlot::tab_model(glmm_nof4,show.intercept = T)
sjPlot::plot_model(glmm_nof4, show.values = TRUE, width = 0.1, title = "effect of competition on flower number per infructescence") 
```
## interactions
```{r}
glmm_nof_sc<- glmer.nb(no_flowers_tt~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nof_tc<- glmer.nb(no_flowers_tt~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nof_sc,show.intercept = T)
plot_model(glmm_nof_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on number of flower") 
sjPlot::tab_model(glmm_nof_tc,show.intercept = T)
plot_model(glmm_nof_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on number of flower") 
```
## post hoc analysis
```{r}
summary(glht(glmm_nof1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_nof1)
plot(check_glmm_test)
```
```{r}
check_overdispersion(glmm_nof1)

```
with poisson family: 
  dispersion ratio =    5.653
  Pearson's Chi-Squared = 1967.248
                p-value =  < 0.001
## final graph
```{r}
a<-fixef(glmm_nof1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_nol1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the number of flower")
plot_final

```
##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$no_flowers_tt <- predict(glmm_nof_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_nof_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_nof_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_nof_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$no_flowers_tt-cmult*sqrt(pvar1)
    , phi = newdat$no_flowers_tt+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)

newdat<-newdat %>% transform(no_flowers_tt=exp(no_flowers_tt),plo=exp(plo),phi=exp(phi))
#plot confidence
g0_nof <- ggplot(newdat, aes(x=treat2.y, y=no_flowers_tt, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("number of inflorescence/ individual")

g0_nof<-ggdraw(add_sub(g0_nof,"  Competition:*** Site:*** Temperature:NS"))

g0_nof
```

# glmm on leaf length
```{r}
glmm_ll1<- lmer(leaf_length_mm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ll2<- lmer(leaf_length_mm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ll3<- lmer(leaf_length_mm~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_ll4<- lmer(leaf_length_mm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_ll1,show.intercept = T)
sjPlot::plot_model(glmm_ll1, show.values = TRUE, width = 0.1, title = "effect of treatment on leaf length")


sjPlot::tab_model(glmm_ll2,show.intercept = T)
sjPlot::plot_model(glmm_ll2, show.values = TRUE, width = 0.1, title = "effect of transplantation on leaf length") 

sjPlot::tab_model(glmm_ll3,show.intercept = T)
sjPlot::plot_model(glmm_ll3, show.values = TRUE, width = 0.1, title = "effect of warming on leaf length") 

sjPlot::tab_model(glmm_ll4,show.intercept = T)
sjPlot::plot_model(glmm_ll4, show.values = TRUE, width = 0.1, title = "effect of competition on leaf length") 
```
## interactions
```{r}
glmm_ll_sc<- lmer(leaf_length_mm~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ll_tc<- lmer(leaf_length_mm~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_ll_sc,show.intercept = T)
plot_model(glmm_ll_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on leaf length") 
sjPlot::tab_model(glmm_ll_tc,show.intercept = T)
plot_model(glmm_ll_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on leaf lengthr") 
```
## post hoc analysis
```{r}
summary(glht(glmm_ll1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_ll1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_ll1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the leaf length")
plot_final

```
##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$leaf_length_mm <- predict(glmm_ll_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_ll_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_ll_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_ll_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$leaf_length_mm-cmult*sqrt(pvar1)
    , phi = newdat$leaf_length_mm+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_ll <- ggplot(newdat, aes(x=treat2.y, y=leaf_length_mm, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("leaf length (mm)")

g0_ll<-ggdraw(add_sub(g0_ll, "Competition: Site: Temperature: "))

g0_ll


```

# glmm on leaf thickness
```{r}
glmm_lt1<- lmer(thickness~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
glmm_lt2<- lmer(thickness~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_lt3<- lmer(thickness~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_lt4<- lmer(thickness~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_lt1,show.intercept = T)
sjPlot::plot_model(glmm_lt1, show.values = TRUE, width = 0.1, title = "effect of treatment on leaf thickness")


sjPlot::tab_model(glmm_lt2,show.intercept = T)
sjPlot::plot_model(glmm_lt2, show.values = TRUE, width = 0.1, title = "effect of transplantation on leaf thickness") 

sjPlot::tab_model(glmm_lt3,show.intercept = T)
sjPlot::plot_model(glmm_lt3, show.values = TRUE, width = 0.1, title = "effect of warming on leaf thickness") 

sjPlot::tab_model(glmm_lt4,show.intercept = T)
sjPlot::plot_model(glmm_lt4, show.values = TRUE, width = 0.1, title = "effect of competition on leaf thickness") 
```
## interactions
```{r}
glmm_lt_sc<- lmer(thickness~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_lt_tc<- lmer(thickness~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_lt_sc,show.intercept = T)
plot_model(glmm_lt_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on leaf thickness") 
sjPlot::tab_model(glmm_lt_tc,show.intercept = T)
plot_model(glmm_lt_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition onleaf thickness") 
```
## post hoc analysis
```{r}
summary(glht(glmm_lt1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_lt1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_lt1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the leaf thickness")
plot_final

```
##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$thickness <- predict(glmm_lt_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_lt_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_lt_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_lt_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$thickness-cmult*sqrt(pvar1)
    , phi = newdat$thickness+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_lt <- ggplot(newdat, aes(x=treat2.y, y=thickness, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("leaf thickness (mm)")

g0_lt<-ggdraw(add_sub(g0_lt, "Competition: Site: Temperature: "))

g0_lt
```


# glmm on leaf width
```{r}
glmm_lw1<- lmer(leaf_width_mm~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
glmm_lw2<- lmer(leaf_width_mm~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_lw3<- lmer(leaf_width_mm~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_lw4<- lmer(leaf_width_mm~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_lw1,show.intercept = T)
sjPlot::plot_model(glmm_lw1, show.values = TRUE, width = 0.1, title = "effect of treatment on leaf thickness")


sjPlot::tab_model(glmm_lw2,show.intercept = T)
sjPlot::plot_model(glmm_lw2, show.values = TRUE, width = 0.1, title = "effect of transplantation on leaf width") 

sjPlot::tab_model(glmm_lw3,show.intercept = T)
sjPlot::plot_model(glmm_lw3, show.values = TRUE, width = 0.1, title = "effect of warming on leaf width") 

sjPlot::tab_model(glmm_lw4,show.intercept = T)
sjPlot::plot_model(glmm_lw4, show.values = TRUE, width = 0.1, title = "effect of competition on leaf width") 
```
## interactions
```{r}
glmm_lw_sc<- lmer(leaf_width_mm~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_lw_tc<- lmer(leaf_width_mm~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_lw_sc,show.intercept = T)
plot_model(glmm_lw_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on leaf width") 
sjPlot::tab_model(glmm_lt_tc,show.intercept = T)
plot_model(glmm_lw_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on leaf width") 
```
## post hoc analysis
```{r}
summary(glht(glmm_lw1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_lw1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_lw1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the leaf width")
plot_final

```
##final graph with confidence interval

```{r}
newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$leaf_width_mm <- predict(glmm_lw_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_lw_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_lw_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_lw_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$leaf_width_mm-cmult*sqrt(pvar1)
    , phi = newdat$leaf_width_mm+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_lw <- ggplot(newdat, aes(x=treat2.y, y=leaf_width_mm, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("leaf width (mm)")

g0_lw<-ggdraw(add_sub(g0_lw, "Competition: Site: Temperature: "))

g0_lw
```

# glmm on number of reproductive stem
```{r}
glmm_nrs1<- glmer.nb(no_rep_stems~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)
glmm_nrs2<- glmer.nb(no_rep_stems~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nrs3<- glmer.nb(no_rep_stems~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_nrs4<- glmer.nb(no_rep_stems~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nrs1,show.intercept = T)
sjPlot::plot_model(glmm_nrs1, show.values = TRUE, width = 0.1, title = "effect of treatment on number of reproductiv stems")


sjPlot::tab_model(glmm_nrs2,show.intercept = T)
sjPlot::plot_model(glmm_nrs2, show.values = TRUE, width = 0.1, title = "effect of transplantation on number of reproductiv stems") 

sjPlot::tab_model(glmm_nrs3,show.intercept = T)
sjPlot::plot_model(glmm_nrs3, show.values = TRUE, width = 0.1, title = "effect of warming on number of reproductiv stems") 

sjPlot::tab_model(glmm_nrs4,show.intercept = T)
sjPlot::plot_model(glmm_nrs4, show.values = TRUE, width = 0.1, title = "effect of competition on number of reproductiv stems") 
```

## interactions
```{r}
glmm_nrs_sc<- glmer.nb(no_rep_stems~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_nrs_tc<- glmer.nb(no_rep_stems~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_nrs_sc,show.intercept = T)
plot_model(glmm_nrs_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on number of reproductiv stems") 
sjPlot::tab_model(glmm_lt_tc,show.intercept = T)
plot_model(glmm_lt_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on number of reproductiv stems") 
```
## post hoc analysis
```{r}
summary(glht(glmm_nrs1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_nrs1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_nrs1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the leaf thickness")
plot_final

```

##final graph with confidence interval
transform(df, points = points / 2)

```{r}

newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    ,no_rep_stems = 0
)

newdat$no_rep_stems <- predict(glmm_nrs_tc,newdat,re.form=NA) # log link function : retransforme with exp
mm <- model.matrix(terms(glmm_nrs_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_nrs_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_nrs_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$no_rep_stems-cmult*sqrt(pvar1)
    , phi = newdat$no_rep_stems+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
newdat<-newdat %>% transform(no_rep_stems=exp(no_rep_stems),plo=exp(plo),phi=exp(phi))
g0_nrs <- ggplot(newdat, aes(x=treat2.y, y=no_rep_stems, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("number of reproductive stems")

g0_nrs<-ggdraw(add_sub(g0_nrs, "Competition: Site: Temperature: "))

g0_nrs
```
# glmm on dry mass
```{r}
glmm_dm1<- lmer(dry_mass~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_dm2<- lmer(dry_mass~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_dm3<- lmer(dry_mass~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_dm4<- lmer(dry_mass~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_dm1,show.intercept = T)
sjPlot::plot_model(glmm_dm1, show.values = TRUE, width = 0.1, title = "effect of treatment on dry mass")


sjPlot::tab_model(glmm_dm2,show.intercept = T)
sjPlot::plot_model(glmm_dm2, show.values = TRUE, width = 0.1, title = "effect of transplantation on dry  mass") 

sjPlot::tab_model(glmm_dm3,show.intercept = T)
sjPlot::plot_model(glmm_dm3, show.values = TRUE, width = 0.1, title = "effect of warming on dry mass") 

sjPlot::tab_model(glmm_dm4,show.intercept = T)
sjPlot::plot_model(glmm_dm4, show.values = TRUE, width = 0.1, title = "effect of competition on dry mass") 
```
## interactions
```{r}
glmm_dm_sc<- lmer(dry_mass~site*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_dm_tc<- lmer(dry_mass~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_dm_sc,show.intercept = T)
plot_model(glmm_dm_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on dry mass") 
sjPlot::tab_model(glmm_dm_tc,show.intercept = T)
plot_model(glmm_dm_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on dry mass") 
```
## post hoc analysis
```{r}
summary(glht(glmm_dm1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_dm1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_dm1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence the leaf length")
plot_final

```
#final graph with confidence interval
```{r}
glmm_dm_tc<- lmer(dry_mass~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    , dry_mass = 0
)

newdat$dry_mass <- predict(glmm_dm_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_dm_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_dm_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_dm_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$dry_mass-cmult*sqrt(pvar1)
    , phi = newdat$dry_mass+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_dm <- ggplot(newdat, aes(x=treat2.y, y=dry_mass, colour=temperature))+
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+

  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")

g0_dm<-ggdraw(add_sub(g0_dm, "Competition: Site: Temperature: "))

g0_dm
```


# glmm on LDMC
```{r}
glmm_ldmc1<- lmer(LDMC~condi + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ldmc2<- lmer(LDMC~site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ldmc3<- lmer(LDMC~temperature +  (1|blockID.y)+ (1|species), data=all_trait_pca)


glmm_ldmc4<- lmer(LDMC~treat2.y +  (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_ldmc1,show.intercept = T)
sjPlot::plot_model(glmm_ldmc1, show.values = TRUE, width = 0.1, title = "effect of treatment on LDMC")


sjPlot::tab_model(glmm_ldmc2,show.intercept = T)
sjPlot::plot_model(glmm_ldmc2, show.values = TRUE, width = 0.1, title = "effect of transplantation on LDMC") 

sjPlot::tab_model(glmm_ldmc3,show.intercept = T)
sjPlot::plot_model(glmm_ldmc3, show.values = TRUE, width = 0.1, title = "effect of warming on LDMC") 

sjPlot::tab_model(glmm_dm4,show.intercept = T)
sjPlot::plot_model(glmm_dm4, show.values = TRUE, width = 0.1, title = "effect of competition on LDMC") 
```
## interactions
```{r}
glmm_ldmc_sc<- lmer(LDMC~treat2.y*site + (1|blockID.y)+ (1|species), data=all_trait_pca)

glmm_ldmc_tc<- lmer(LDMC~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)


sjPlot::tab_model(glmm_ldmc_sc,show.intercept = T)
plot_model(glmm_ldmc_sc, show.values = TRUE, width = 0.1, title = "interaction of site and competition on LDMC") 
sjPlot::tab_model(glmm_ldmc_tc,show.intercept = T)
plot_model(glmm_ldmc_tc, show.values = TRUE, width = 0.1, title = "interactions of temperature and competition on LDMC") 
```
## post hoc analysis
```{r}
summary(glht(glmm_ldmc1, mcp(condi="Tukey")))

```


## check model
```{r}
check_glmm_test<-check_model(glmm_ldmc1)
plot(check_glmm_test)
```


## final graph
```{r}
a<-fixef(glmm_ldmc1)
b<-as.data.frame(a)
rname<- gsub("condi", "", row.names(b)[-1])
b<-append(b[,][-1],0)
rname<-append(rname,"HS A")

#confidence interval
CI<-coef(summary(glmm_ll1))
CI_HSA<-CI[,"Std. Error"][1]/a[1] #à vérifier
CI<-as.data.frame(append(CI[,"Std. Error"][-1],CI_HSA))[,]

df_plot<-data.frame(condi=rname,value=b)
df_plot<-df_plot %>%mutate(competition=c("Vegetation","Bare","Bare","Vegetation", "Bare", "Vegetation"),temperature= c("High ambient", "High warm", "High ambient", "Low ambient", "Low ambient", "High warm"),CI=CI)



plot_final<-ggplot(df_plot,aes(x=competition,y=value,fill=temperature))+
  geom_dotplot(binaxis='y',dotsize = 2)+
  geom_path(aes(group = temperature, color = temperature))+
  ylab("value of glmm")+
  ggtitle("Warming, transplantation and competition influence LDMC")
plot_final

```

data("Orthodont",package="MEMSS")
fm1 <- lmer(
    formula = distance ~ age*Sex + (age|Subject)
    , data = Orthodont
)

glmm_ldmc_sc<- lmer(LDMC~treat2.y*site + (1|blockID.y)+ (1|species), data=all_trait_pca)

newdat <- expand.grid(
    age=c(8,10,12,14)
    , Sex=c("Female","Male")
    , distance = 0
)
newdat$distance <- predict(fm1,newdat,re.form=NA)
mm <- model.matrix(terms(fm1),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(fm1),mm))
tvar1 <- pvar1+VarCorr(fm1)$Subject[1]  ## must be adapted for more complex models
cmult <- 2 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$distance-cmult*sqrt(pvar1)
    , phi = newdat$distance+cmult*sqrt(pvar1)
    , tlo = newdat$distance-cmult*sqrt(tvar1)
    , thi = newdat$distance+cmult*sqrt(tvar1)
)
#plot confidence
g0 <- ggplot(newdat, aes(x=age, y=distance, colour=Sex))+geom_point()
g0 + geom_pointrange(aes(ymin = plo, ymax = phi))+
    labs(title="CI based on fixed-effects uncertainty ONLY")

#final graph with confidence interval
```{r}
glmm_ldmc_tc<- lmer(LDMC~treat2.y*temperature + (1|blockID.y)+ (1|species), data=all_trait_pca)

newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    , LDMC = 0
)

newdat$LDMC <- predict(glmm_ldmc_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_ldmc_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_ldmc_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_ldmc_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$LDMC-cmult*sqrt(pvar1)
    , phi = newdat$LDMC+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_ldmc <- ggplot(newdat, aes(x=treat2.y, y=LDMC, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("LDMC(mg/g")

g0_ldmc<-ggdraw(add_sub(g0_ldmc, "Competition:*** Site:* Temperature:NS"))

g0_ldmc
```


# glmm on seed weight
```{r}
all_trait_pca<-all_trait_pca %>% mutate(weight.seed.log2=log(weight.seed.log))


glmm_wps_tc<- lmer(weight.seed.log2~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

```
#final graph with confidence interval
```{r}

newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    , LDMC = 0
)

newdat$weight.seed.log2 <- predict(glmm_wps_tc,newdat,re.form=NA)
mm <- model.matrix(terms(glmm_wps_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_wps_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_wps_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$weight.seed.log2-cmult*sqrt(pvar1)
    , phi = newdat$weight.seed.log2+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)
#plot confidence
g0_wps <- ggplot(newdat, aes(x=treat2.y, y=weight.seed.log2, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("log(seed weight)")

g0_wps<-ggdraw(add_sub(g0_wps, "   Competition:NS Site:** Temperature:NS"))
g0_wps
```
# glmm on seed weight
```{r}
glmm_sn_tc<- glmer.nb(seeds_number.inf~temperature*treat2.y + (1|blockID.y)+ (1|species), data=all_trait_pca)

```

glmm_sn_tc<- glmer.nb(seeds_number.inf~temp*treat2 + (1|blockID)+ (1|species), data=df)
#final graph with confidence interval
```{r}

newdat <- expand.grid(
    treat2.y=c("bare","vege")
    , temperature=c("ambient HS","warm HS", " ambient LS")
    , seeds_number.inf = 0
)

newdat$seeds_number.inf <- predict(glmm_sn_tc,newdat,re.form=NA) # we are using a negative binomial family, with a log link function ( default mass package) so we transform with exp.
mm <- model.matrix(terms(glmm_sn_tc),newdat)
## or newdat$distance <- mm %*% fixef(fm1)
pvar1 <- diag(mm %*% tcrossprod(vcov(glmm_sn_tc),mm))
tvar1 <- pvar1+VarCorr(glmm_sn_tc)$Subject[1]  ## must be adapted for more complex models
cmult <- 1.96 ## could use 1.96
newdat <- data.frame(
    newdat
    , plo = newdat$seeds_number.inf-cmult*sqrt(pvar1)
    , phi = newdat$seeds_number.inf+cmult*sqrt(pvar1)
 #   , tlo = newdat$LDMC-cmult*sqrt(tvar1)
  #  , thi = newdat$LDMC+cmult*sqrt(tvar1)
)


newdat<-newdat %>% transform(seeds_number.inf=exp(seeds_number.inf),plo=exp(plo),phi=exp(phi))

#plot confidence
g0_sn <- ggplot(newdat, aes(x=treat2.y, y=seeds_number.inf, colour=temperature)) +
  geom_path(aes(group = temperature, color = temperature),linewidth=0.75,position = position_dodge(width = 0.15))+
  geom_pointrange(aes(ymin = plo, ymax = phi),position = position_dodge(width = 0.15), linewidth=0.75, size=1)+
  xlab("Competition")+
  ylab("seed number")

g0_sn<-ggdraw(add_sub(g0_sn, "   Competition:NS Site:NS Temperature:NS"))
g0_sn
```

combined <- p1 + p2 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```{r}
g0_total1<-ggarrange(g0_nof,g0_nol, g0_nrs, g0_ldmc, g0_lt, ncol=3, nrow=2, common.legend = TRUE, legend="bottom")

g0_total2<-ggarrange(g0_lw, g0_ll, g0_dm, g0_vegh, g0_reph, g0_wps, ncol=3, nrow=2, common.legend = TRUE, legend="bottom")
g0_total3<-ggarrange(g0_vegh, g0_reph, ncol=2, nrow=1, common.legend = TRUE, legend="bottom")
g0_total1
g0_total2
g0_total3
```

